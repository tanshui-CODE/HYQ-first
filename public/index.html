<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å››å·åç‰è½¦è¾†æ¿ç°§æœ‰é™å…¬å¸ - å¤–è´¸å®¢æˆ·ç®¡ç†ç³»ç»Ÿ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-orange: #f97316;
      --primary-blue: #2563eb;
      --secondary-orange: #ea580c;
      --secondary-blue: #1d4ed8;
      --light-orange: #ffedd5;
      --light-blue: #dbeafe;
    }
    .sidebar-item.active { background: linear-gradient(90deg, #f97316 0%, #ea580c 100%); }
    .bg-gradient-to-r.from-blue-500.to-purple-500 { background: linear-gradient(90deg, #f97316 0%, #2563eb 100%) !important; }
    .bg-gradient-to-r.from-purple-500.to-pink-500 { background: linear-gradient(90deg, #2563eb 0%, #f97316 100%) !important; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(249, 115, 22, 0.15); }
    .fade-in { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal { backdrop-filter: blur(4px); }
    .login-left {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 50%, #2563eb 100%);
      position: relative;
      overflow: hidden;
    }
    .btn-primary { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
    .btn-primary:hover { background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%); }
    .text-primary-orange { color: #f97316; }
    .text-primary-blue { color: #2563eb; }
    .border-primary-orange { border-color: #f97316; }
    .border-primary-blue { border-color: #2563eb; }
    .bg-primary-orange { background-color: #f97316; }
    .bg-primary-blue { background-color: #2563eb; }
    .hover\:bg-orange-600:hover { background-color: #ea580c; }
    .hover\:text-orange-600:hover { color: #ea580c; }
    .login-left::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      animation: rotate 60s linear infinite;
    }
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .float-animation {
      animation: float 6s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }
    .pulse-ring {
      animation: pulse-ring 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
    }
    @keyframes pulse-ring {
      0% { transform: scale(0.8); opacity: 1; }
      100% { transform: scale(1.5); opacity: 0; }
    }
    .input-group {
      position: relative;
    }
    .input-group input:focus + .input-icon {
      color: #3b82f6;
      transform: scale(1.1);
    }
    .input-icon {
      transition: all 0.3s ease;
    }
    .btn-login {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      transition: all 0.3s ease;
    }
    .btn-login:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(249, 115, 22, 0.4);
    }
    .globe-icon {
      animation: spin 20s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100">
  <div id="app">
    <!-- ç™»å½•é¡µé¢ -->
    <div id="loginPage" class="min-h-screen flex">
      <!-- å·¦ä¾§å“ç‰ŒåŒºåŸŸ -->
      <div class="login-left hidden lg:flex lg:w-1/2 flex-col justify-center items-center text-white p-12 relative z-10">
        <div class="float-animation mb-8">
          <img src="/logo.png" alt="åç‰æ¿ç°§" class="w-48 h-48 object-contain drop-shadow-2xl">
        </div>
        <h1 class="text-4xl font-bold mb-4 text-center">SICHUAN HUAYU</h1>
        <h2 class="text-2xl font-light mb-6 text-center">VEHICLE LEAF SPRING CO., LTD.</h2>
        <p class="text-xl text-blue-200 text-center max-w-md">Professional Automotive Leaf Spring Manufacturer Since 1992</p>
        <div class="mt-12 flex items-center gap-8 text-blue-200">
          <div class="text-center">
            <i class="fas fa-globe globe-icon text-3xl mb-2"></i>
            <p class="text-sm">Global Export</p>
          </div>
          <div class="text-center">
            <i class="fas fa-industry text-3xl mb-2"></i>
            <p class="text-sm">30,000 Tons/Year</p>
          </div>
          <div class="text-center">
            <i class="fas fa-award text-3xl mb-2"></i>
            <p class="text-sm">ISO Certified</p>
          </div>
        </div>
      </div>
      <!-- å³ä¾§ç™»å½•åŒºåŸŸ -->
      <div class="w-full lg:w-1/2 flex items-center justify-center bg-gray-50 p-8">
        <div class="w-full max-w-md">
          <div class="text-center mb-8 lg:hidden">
            <img src="/logo.png" alt="åç‰æ¿ç°§" class="w-24 h-24 mx-auto mb-4 object-contain">
          </div>
          <h2 class="text-3xl font-bold text-gray-800 mb-2">Welcome Back</h2>
          <p class="text-gray-500 mb-8">Sign in to your CRM account</p>
          <form onsubmit="return handleLogin(event)">
            <div class="mb-5">
              <label class="block text-gray-600 text-sm font-medium mb-2">Username</label>
              <div class="relative">
                <input type="text" id="loginUsername" required class="w-full px-4 py-3 pl-11 border-2 border-gray-200 rounded-xl focus:border-orange-500 focus:outline-none transition" placeholder="Enter your username">
                <i class="fas fa-user absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-gray-600 text-sm font-medium mb-2">Password</label>
              <div class="relative">
                <input type="password" id="loginPassword" required class="w-full px-4 py-3 pl-11 border-2 border-gray-200 rounded-xl focus:border-orange-500 focus:outline-none transition" placeholder="Enter your password">
                <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
              </div>
            </div>
            <button type="submit" class="btn-login w-full text-white py-3 rounded-xl font-semibold text-lg">
              <i class="fas fa-sign-in-alt mr-2"></i>Sign In
            </button>
          </form>
          <div class="mt-8 pt-6 border-t border-gray-200 text-center">
            <p class="text-gray-400 text-sm">å››å·åç‰è½¦è¾†æ¿ç°§æœ‰é™å…¬å¸</p>
            <p class="text-gray-400 text-xs mt-1">å¤–è´¸å®¢æˆ·ç®¡ç†ç³»ç»Ÿ</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="mainApp" class="hidden">
      <!-- ä¾§è¾¹æ  -->
      <div class="fixed left-0 top-0 h-full w-64 bg-gradient-to-b from-orange-600 to-orange-800 text-white z-50">
        <div class="p-6 border-b border-orange-400">
          <h1 class="text-lg font-bold flex items-center">
            <i class="fas fa-industry mr-2"></i>åç‰æ¿ç°§CRM
          </h1>
          <p class="text-gray-400 text-sm mt-1">å¤–è´¸å®¢æˆ·ç®¡ç†ç³»ç»Ÿ</p>
        </div>
        <nav class="p-4">
          <div onclick="showPage('dashboard')" class="sidebar-item active flex items-center px-4 py-3 rounded-lg cursor-pointer mb-2 hover:bg-gray-800 transition">
            <i class="fas fa-chart-line w-6"></i><span>æ•°æ®çœ‹æ¿</span>
          </div>
          <div onclick="showPage('customers')" class="sidebar-item flex items-center px-4 py-3 rounded-lg cursor-pointer mb-2 hover:bg-gray-800 transition">
            <i class="fas fa-users w-6"></i><span>å®¢æˆ·ç®¡ç†</span>
          </div>
          <div onclick="showPage('products')" class="sidebar-item flex items-center px-4 py-3 rounded-lg cursor-pointer mb-2 hover:bg-gray-800 transition">
            <i class="fas fa-box w-6"></i><span>äº§å“ç®¡ç†</span>
          </div>
          <div onclick="showPage('orders')" class="sidebar-item flex items-center px-4 py-3 rounded-lg cursor-pointer mb-2 hover:bg-gray-800 transition">
            <i class="fas fa-shopping-cart w-6"></i><span>è®¢å•ç®¡ç†</span>
          </div>
          <div onclick="showPage('inquiries')" class="sidebar-item flex items-center px-4 py-3 rounded-lg cursor-pointer mb-2 hover:bg-gray-800 transition">
            <i class="fas fa-envelope w-6"></i><span>è¯¢ç›˜ç®¡ç†</span>
          </div>
          <div onclick="showPage('ai')" class="sidebar-item flex items-center px-4 py-3 rounded-lg cursor-pointer mb-2 hover:bg-gray-800 transition">
            <i class="fas fa-robot w-6"></i><span>AIåŠ©æ‰‹</span>
          </div>
        </nav>
        <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-orange-400">
          <div class="flex items-center justify-between">
            <div>
              <p class="font-semibold" id="userName">ç®¡ç†å‘˜</p>
              <p class="text-gray-400 text-sm">åœ¨çº¿</p>
            </div>
            <button onclick="logout()" class="text-gray-400 hover:text-white transition">
              <i class="fas fa-sign-out-alt text-xl"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- ä¸»å†…å®¹åŒº -->
      <div class="ml-64 p-8">
        <!-- æ•°æ®çœ‹æ¿ -->
        <div id="dashboardPage" class="page">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">æ•°æ®çœ‹æ¿</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 card-hover transition">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500">å®¢æˆ·æ€»æ•°</p>
                  <p class="text-3xl font-bold text-gray-800" id="statCustomers">0</p>
                </div>
                <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                  <i class="fas fa-users text-orange-600 text-xl"></i>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl p-6 card-hover transition">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500">è®¢å•æ€»æ•°</p>
                  <p class="text-3xl font-bold text-gray-800" id="statOrders">0</p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                  <i class="fas fa-shopping-cart text-green-600 text-xl"></i>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl p-6 card-hover transition">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500">å¾…å¤„ç†è¯¢ç›˜</p>
                  <p class="text-3xl font-bold text-gray-800" id="statInquiries">0</p>
                </div>
                <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                  <i class="fas fa-envelope text-yellow-600 text-xl"></i>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl p-6 card-hover transition">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500">å¾…å¤„ç†è®¢å•</p>
                  <p class="text-3xl font-bold text-gray-800" id="statPending">0</p>
                </div>
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                  <i class="fas fa-clock text-red-600 text-xl"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="grid grid-cols-1 gap-6">
            <div class="bg-white rounded-xl p-6">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">æ•°æ®å›¾è¡¨</h3>
                <div class="flex gap-2">
                  <button onclick="prevChart()" class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200"><i class="fas fa-chevron-left"></i></button>
                  <span id="chartPageInfo" class="px-3 py-1 text-sm text-gray-500">1 / 4</span>
                  <button onclick="nextChart()" class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200"><i class="fas fa-chevron-right"></i></button>
                </div>
              </div>
              <div id="chartContainer" style="max-height: 350px; overflow: auto; text-align: center;">
                <canvas id="customerTypeChart" height="150"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- å®¢æˆ·ç®¡ç† -->
        <div id="customersPage" class="page hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">å®¢æˆ·ç®¡ç†</h2>
            <div class="flex gap-2">
              <button onclick="downloadTemplate()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">
                <i class="fas fa-download mr-2"></i>ä¸‹è½½æ¨¡æ¿
              </button>
              <button onclick="document.getElementById('excelImport').click()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                <i class="fas fa-file-import mr-2"></i>AIæ™ºèƒ½å¯¼å…¥
              </button>
              <input type="file" id="excelImport" accept=".xlsx,.xls,.csv" class="hidden" onchange="importExcel(event)">
              <button onclick="showCustomerModal()" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">
                <i class="fas fa-plus mr-2"></i>æ·»åŠ å®¢æˆ·
              </button>
            </div>
          </div>
          <div class="bg-white rounded-xl p-6">
            <div class="flex gap-4 mb-4">
              <input type="text" id="customerSearch" placeholder="æœç´¢å®¢æˆ·åç§°/å…¬å¸/é‚®ç®±..." class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" onkeyup="loadCustomers()">
              <select id="customerStatus" class="px-4 py-2 border rounded-lg" onchange="loadCustomers()">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="active">æ´»è·ƒ</option>
                <option value="inactive">ä¸æ´»è·ƒ</option>
                <option value="potential">æ½œåœ¨</option>
              </select>
            </div>
            <div class="overflow-x-auto" style="overflow-x: scroll; -webkit-overflow-scrolling: touch; max-width: 100%;">
              <table class="w-full text-sm" style="min-width: 1800px;">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-2 py-2 text-left text-gray-600">å…¬å¸å</th>
                    <th class="px-2 py-2 text-left text-gray-600">å›½å®¶</th>
                    <th class="px-2 py-2 text-left text-gray-600">åœ°å€</th>
                    <th class="px-2 py-2 text-left text-gray-600">å®¢æˆ·ç±»å‹</th>
                    <th class="px-2 py-2 text-left text-gray-600">å®¢æˆ·ç­‰çº§</th>
                    <th class="px-2 py-2 text-left text-gray-600">ç½‘å€</th>
                    <th class="px-2 py-2 text-left text-gray-600">å…¬å¸ç¤¾åª’è´¦å·</th>
                    <th class="px-2 py-2 text-left text-gray-600">æ‰€æœ‰è”ç³»äºº</th>
                    <th class="px-2 py-2 text-left text-gray-600">è”ç³»æ–¹å¼</th>
                    <th class="px-2 py-2 text-left text-gray-600">ä¸»è¥äº§å“</th>
                    <th class="px-2 py-2 text-left text-gray-600">é‡‡è´­å‘¨æœŸ</th>
                    <th class="px-2 py-2 text-left text-gray-600">å¹´é‡‡è´­é¢</th>
                    <th class="px-2 py-2 text-left text-gray-600">æ¥æºæ¸ é“</th>
                    <th class="px-2 py-2 text-left text-gray-600">è·Ÿè¿›æƒ…å†µ</th>
                    <th class="px-2 py-2 text-left text-gray-600">æœ€æ–°è·Ÿè¿›æ—¶é—´</th>
                    <th class="px-2 py-2 text-left text-gray-600">æœ€æ–°è·Ÿè¿›å†…å®¹</th>
                    <th class="px-2 py-2 text-left text-gray-600">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="customerList"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- äº§å“ç®¡ç† -->
        <div id="productsPage" class="page hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">äº§å“ç®¡ç†</h2>
            <button onclick="showProductModal()" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">
              <i class="fas fa-plus mr-2"></i>æ·»åŠ äº§å“
            </button>
          </div>
          <div class="bg-white rounded-xl p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="productList"></div>
          </div>
        </div>

        <!-- è®¢å•ç®¡ç† -->
        <div id="ordersPage" class="page hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">è®¢å•ç®¡ç†</h2>
            <button onclick="showOrderModal()" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">
              <i class="fas fa-plus mr-2"></i>åˆ›å»ºè®¢å•
            </button>
          </div>
          <div class="bg-white rounded-xl p-6">
            <div class="flex gap-4 mb-4">
              <select id="orderStatus" class="px-4 py-2 border rounded-lg" onchange="loadOrders()">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="pending">å¾…å¤„ç†</option>
                <option value="confirmed">å·²ç¡®è®¤</option>
                <option value="producing">ç”Ÿäº§ä¸­</option>
                <option value="shipped">å·²å‘è´§</option>
                <option value="completed">å·²å®Œæˆ</option>
              </select>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-gray-600">è®¢å•å·</th>
                    <th class="px-4 py-3 text-left text-gray-600">å®¢æˆ·</th>
                    <th class="px-4 py-3 text-left text-gray-600">äº§å“</th>
                    <th class="px-4 py-3 text-left text-gray-600">æ•°é‡</th>
                    <th class="px-4 py-3 text-left text-gray-600">é‡‘é¢</th>
                    <th class="px-4 py-3 text-left text-gray-600">çŠ¶æ€</th>
                    <th class="px-4 py-3 text-left text-gray-600">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="orderList"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- è¯¢ç›˜ç®¡ç† -->
        <div id="inquiriesPage" class="page hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">è¯¢ç›˜ç®¡ç†</h2>
            <button onclick="showInquiryModal()" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">
              <i class="fas fa-plus mr-2"></i>æ·»åŠ è¯¢ç›˜
            </button>
          </div>
          <div class="bg-white rounded-xl p-6">
            <div class="flex gap-4 mb-4">
              <select id="inquiryStatus" class="px-4 py-2 border rounded-lg" onchange="loadInquiries()">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="new">æ–°è¯¢ç›˜</option>
                <option value="processing">å¤„ç†ä¸­</option>
                <option value="quoted">å·²æŠ¥ä»·</option>
                <option value="closed">å·²å…³é—­</option>
              </select>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-gray-600">è¯¢ç›˜ç¼–å·</th>
                    <th class="px-4 py-3 text-left text-gray-600">å®¢æˆ·</th>
                    <th class="px-4 py-3 text-left text-gray-600">äº§å“</th>
                    <th class="px-4 py-3 text-left text-gray-600">æ•°é‡</th>
                    <th class="px-4 py-3 text-left text-gray-600">çŠ¶æ€</th>
                    <th class="px-4 py-3 text-left text-gray-600">æ—¥æœŸ</th>
                    <th class="px-4 py-3 text-left text-gray-600">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="inquiryList"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- AIåŠ©æ‰‹ -->
        <div id="aiPage" class="page hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">AIæ™ºèƒ½åŠ©æ‰‹</h2>
          </div>
          
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
              <div class="bg-white rounded-xl p-6 h-[600px] flex flex-col">
                <div class="flex items-center gap-3 pb-4 border-b">
                  <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                    <i class="fas fa-robot text-white"></i>
                  </div>
                  <div>
                    <h3 class="font-semibold">åç‰AIåŠ©æ‰‹</h3>
                    <p class="text-sm text-gray-500">åŸºäºDeepSeekå¤§æ¨¡å‹</p>
                  </div>
                </div>
                
                <div id="aiChatMessages" class="flex-1 overflow-y-auto py-4 space-y-4">
                  <div class="flex gap-3">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center flex-shrink-0">
                      <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-gray-100 rounded-lg p-3 max-w-[80%]">
                      <p class="text-gray-700">æ‚¨å¥½ï¼æˆ‘æ˜¯åç‰AIåŠ©æ‰‹ï¼Œå¯ä»¥å¸®æ‚¨åˆ†æå®¢æˆ·æ•°æ®ã€è®¢å•æƒ…å†µå’Œä¸šåŠ¡è¶‹åŠ¿ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„ï¼Ÿ</p>
                    </div>
                  </div>
                </div>
                
                <div class="pt-4 border-t">
                  <div class="flex gap-2">
                    <input type="text" id="aiInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šåˆ†æä¸€ä¸‹å®¢æˆ·åˆ†å¸ƒæƒ…å†µ" 
                      class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                      onkeypress="if(event.key==='Enter')sendAIMessage()">
                    <button onclick="sendAIMessage()" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg hover:opacity-90 transition">
                      <i class="fas fa-paper-plane"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="space-y-6">
              <div class="bg-white rounded-xl p-6">
                <h3 class="font-semibold mb-4"><i class="fas fa-key mr-2 text-blue-500"></i>APIè®¾ç½®</h3>
                <div class="space-y-3">
                  <div>
                    <label class="block text-sm text-gray-600 mb-1">DeepSeek API Key</label>
                    <input type="password" id="deepseekApiKey" placeholder="sk-xxxxxxxxxxxxxxxx" 
                      class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
                  </div>
                  <button onclick="saveApiKey()" class="w-full py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition text-sm">
                    ä¿å­˜API Key
                  </button>
                </div>
              </div>
              
              <div class="bg-white rounded-xl p-6">
                <h3 class="font-semibold mb-4"><i class="fas fa-lightbulb mr-2 text-yellow-500"></i>å¿«æ·æé—®</h3>
                <div class="space-y-2">
                  <button onclick="quickAsk('åˆ†æä¸€ä¸‹å®¢æˆ·åˆ†å¸ƒæƒ…å†µ')" class="w-full text-left px-3 py-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition text-sm">
                    ğŸ“Š åˆ†æå®¢æˆ·åˆ†å¸ƒæƒ…å†µ
                  </button>
                  <button onclick="quickAsk('å“ªäº›å®¢æˆ·æœ€è¿‘æ²¡æœ‰è·Ÿè¿›')" class="w-full text-left px-3 py-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition text-sm">
                    ğŸ” æŸ¥æ‰¾éœ€è¦è·Ÿè¿›çš„å®¢æˆ·
                  </button>
                  <button onclick="quickAsk('åˆ†æè®¢å•è¶‹åŠ¿å’Œé”€å”®é¢')" class="w-full text-left px-3 py-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition text-sm">
                    ğŸ“ˆ åˆ†æè®¢å•è¶‹åŠ¿
                  </button>
                  <button onclick="quickAsk('ç»™æˆ‘ä¸€äº›å®¢æˆ·å¼€å‘å»ºè®®')" class="w-full text-left px-3 py-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition text-sm">
                    ğŸ’¡ å®¢æˆ·å¼€å‘å»ºè®®
                  </button>
                  <button onclick="quickAsk('åˆ†æè¯¢ç›˜è½¬åŒ–ç‡')" class="w-full text-left px-3 py-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition text-sm">
                    ğŸ“‹ åˆ†æè¯¢ç›˜è½¬åŒ–ç‡
                  </button>
                </div>
              </div>
              
              <div class="bg-white rounded-xl p-6">
                <h3 class="font-semibold mb-4"><i class="fas fa-globe mr-2 text-green-500"></i>è”ç½‘åˆ†æ</h3>
                <div class="space-y-3">
                  <div>
                    <label class="block text-sm text-gray-600 mb-1">è¾“å…¥å…¬å¸åæˆ–ç½‘å€</label>
                    <input type="text" id="webSearchQuery" placeholder="ä¾‹å¦‚ï¼šABC Company æˆ– https://abc.com" 
                      class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:outline-none">
                  </div>
                  <button onclick="analyzeCompanyOnline()" class="w-full py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm">
                    <i class="fas fa-search mr-1"></i>è”ç½‘åˆ†æå…¬å¸
                  </button>
                </div>
              </div>

              <div class="bg-white rounded-xl p-6">
                <h3 class="font-semibold mb-4"><i class="fas fa-file-import mr-2 text-purple-500"></i>æ¨¡æ¿å¯¼å…¥</h3>
                <div class="space-y-3">
                  <p class="text-sm text-gray-600">ä¸‹è½½æ¨¡æ¿ï¼Œå¡«å†™åå¯¼å…¥å®¢æˆ·æ•°æ®</p>
                  <button onclick="downloadTemplate()" class="w-full py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition text-sm">
                    <i class="fas fa-download mr-1"></i>ä¸‹è½½Excelæ¨¡æ¿
                  </button>
                  <button onclick="document.getElementById('aiExcelImport').click()" class="w-full py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition text-sm">
                    <i class="fas fa-upload mr-1"></i>å¯¼å…¥å®¢æˆ·æ•°æ®
                  </button>
                  <input type="file" id="aiExcelImport" accept=".xlsx,.xls,.csv" class="hidden" onchange="importExcelFromAI(event)">
                </div>
              </div>

              <div class="bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl p-6 text-white">
                <h3 class="font-semibold mb-2"><i class="fas fa-info-circle mr-2"></i>AIèƒ½åŠ›è¯´æ˜</h3>
                <ul class="text-sm space-y-1 text-blue-100">
                  <li>â€¢ åˆ†æå®¢æˆ·æ•°æ®å’Œç”»åƒ</li>
                  <li>â€¢ è”ç½‘æœç´¢å…¬å¸ä¿¡æ¯</li>
                  <li>â€¢ æ™ºèƒ½å¯¼å…¥Excelæ•°æ®</li>
                  <li>â€¢ é¢„æµ‹é”€å”®è¶‹åŠ¿</li>
                  <li>â€¢ æä¾›ä¸šåŠ¡å»ºè®®</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å®¢æˆ·æ¨¡æ€æ¡† -->
    <div id="customerModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 overflow-y-auto">
      <div class="bg-white rounded-xl p-6 w-full max-w-4xl mx-4 my-8 fade-in">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold" id="customerModalTitle">æ·»åŠ å®¢æˆ·</h3>
          <button onclick="closeCustomerModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
        </div>
        <form onsubmit="saveCustomer(event)">
          <input type="hidden" id="customerId">
          <div class="grid grid-cols-2 gap-4">
            <div class="col-span-2">
              <label class="block text-gray-700 mb-1">å®¢æˆ·åç§° *</label>
              <input type="text" id="customerName" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>
            <div class="col-span-2">
              <label class="block text-gray-700 mb-1">å…¬å¸åç§°</label>
              <input type="text" id="customerCompany" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 mb-1">å›½å®¶ *</label>
              <input type="text" id="customerCountry" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 mb-1">çŠ¶æ€</label>
              <select id="customerStatusInput" class="w-full px-3 py-2 border rounded-lg">
                <option value="potential">æ½œåœ¨</option>
                <option value="active">æ´»è·ƒ</option>
                <option value="inactive">ä¸æ´»è·ƒ</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-700 mb-1">å®¢æˆ·ç±»å‹</label>
              <select id="customerTypeInput" class="w-full px-3 py-2 border rounded-lg">
                <option value="">è¯·é€‰æ‹©</option>
                <option value="distributor">åˆ†é”€å•†</option>
                <option value="chassis">åº•ç›˜å•†</option>
                <option value="manufacturer">åˆ¶é€ å•†</option>
                <option value="other">å…¶ä»–</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-700 mb-1">å®¢æˆ·ç­‰çº§</label>
              <select id="customerLevelInput" class="w-full px-3 py-2 border rounded-lg">
                <option value="">è¯·é€‰æ‹©</option>
                <option value="A">Açº§ (æ ¸å¿ƒå®¢æˆ·)</option>
                <option value="B">Bçº§ (é‡è¦å®¢æˆ·)</option>
                <option value="C">Cçº§ (æ™®é€šå®¢æˆ·)</option>
              </select>
            </div>
            <div class="col-span-2">
              <label class="block text-gray-700 mb-1">åœ°å€</label>
              <input type="text" id="customerAddress" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 mb-1">ç½‘å€</label>
              <input type="url" id="customerWebsite" placeholder="https://" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 mb-1">å…¬å¸ç¤¾åª’è´¦å·</label>
              <input type="url" id="customerSocialMedia" placeholder="https://" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 mb-1">æ‰€æœ‰è”ç³»äºº</label>
              <input type="text" id="customerContactPerson" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 mb-1">è”ç³»æ–¹å¼</label>
              <input type="text" id="customerContactInfo" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none">
            </div>
            <div class="col-span-2">
              <label class="block text-gray-700 mb-1">ä¸»è¥äº§å“</label>
              <input type="text" id="customerMainProducts" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 mb-1">é‡‡è´­å‘¨æœŸ</label>
              <input type="text" id="customerPurchaseCycle" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 mb-1">å¹´é‡‡è´­é¢</label>
              <input type="text" id="customerAnnualPurchase" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 mb-1">æ¥æºæ¸ é“</label>
              <input type="text" id="customerSourceChannel" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 mb-1">è·Ÿè¿›æƒ…å†µ</label>
              <input type="text" id="customerFollowUpStatus" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 mb-1">æœ€æ–°è·Ÿè¿›æ—¶é—´</label>
              <input type="date" id="customerLastFollowUp" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none">
            </div>
            <div class="col-span-2">
              <label class="block text-gray-700 mb-1">æœ€æ–°è·Ÿè¿›å†…å®¹</label>
              <textarea id="customerFollowUpContent" rows="2" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none"></textarea>
            </div>
          </div>
          <div class="flex justify-end gap-2 mt-4">
            <button type="button" onclick="closeCustomerModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-100">å–æ¶ˆ</button>
            <button type="submit" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <!-- äº§å“æ¨¡æ€æ¡† -->
    <div id="productModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4 fade-in">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold" id="productModalTitle">æ·»åŠ äº§å“</h3>
          <button onclick="closeProductModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
        </div>
        <form onsubmit="saveProduct(event)">
          <input type="hidden" id="productId">
          <div class="grid grid-cols-2 gap-4">
            <div class="col-span-2">
              <label class="block text-gray-700 mb-1">äº§å“åç§° *</label>
              <input type="text" id="productName" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 mb-1">äº§å“ç±»åˆ«</label>
              <select id="productCategory" class="w-full px-3 py-2 border rounded-lg">
                <option value="é‡å‹è½¦ç³»åˆ—">é‡å‹è½¦ç³»åˆ—</option>
                <option value="è½»å‹è½¦ç³»åˆ—">è½»å‹è½¦ç³»åˆ—</option>
                <option value="å®¢è½¦ç³»åˆ—">å®¢è½¦ç³»åˆ—</option>
                <option value="æŒ‚è½¦ç³»åˆ—">æŒ‚è½¦ç³»åˆ—</option>
                <option value="å·¥ç¨‹è½¦ç³»åˆ—">å·¥ç¨‹è½¦ç³»åˆ—</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-700 mb-1">æè´¨è§„æ ¼</label>
              <input type="text" id="productSpec" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 mb-1">åšåº¦èŒƒå›´</label>
              <input type="text" id="productThickness" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 mb-1">å®½åº¦èŒƒå›´</label>
              <input type="text" id="productWidth" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>
            <div class="col-span-2">
              <label class="block text-gray-700 mb-1">äº§å“æè¿°</label>
              <textarea id="productDescription" rows="2" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
            </div>
          </div>
          <div class="flex justify-end gap-2 mt-4">
            <button type="button" onclick="closeProductModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-100">å–æ¶ˆ</button>
            <button type="submit" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <!-- è®¢å•æ¨¡æ€æ¡† -->
    <div id="orderModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4 fade-in">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">åˆ›å»ºè®¢å•</h3>
          <button onclick="closeOrderModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
        </div>
        <form onsubmit="saveOrder(event)">
          <div class="grid grid-cols-2 gap-4">
            <div class="col-span-2">
              <label class="block text-gray-700 mb-1">å®¢æˆ· *</label>
              <select id="orderCustomer" required class="w-full px-3 py-2 border rounded-lg"></select>
            </div>
            <div class="col-span-2">
              <label class="block text-gray-700 mb-1">äº§å“ *</label>
              <select id="orderProduct" required class="w-full px-3 py-2 border rounded-lg"></select>
            </div>
            <div>
              <label class="block text-gray-700 mb-1">æ•°é‡ *</label>
              <input type="number" id="orderQuantity" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 mb-1">å•ä½</label>
              <select id="orderUnit" class="w-full px-3 py-2 border rounded-lg">
                <option value="å¨">å¨</option>
                <option value="å¥—">å¥—</option>
                <option value="ä»¶">ä»¶</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-700 mb-1">å•ä»·(USD)</label>
              <input type="number" id="orderPrice" step="0.01" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 mb-1">æ€»é‡‘é¢(USD)</label>
              <input type="number" id="orderAmount" step="0.01" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>
            <div class="col-span-2">
              <label class="block text-gray-700 mb-1">å¤‡æ³¨</label>
              <textarea id="orderNotes" rows="2" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
            </div>
          </div>
          <div class="flex justify-end gap-2 mt-4">
            <button type="button" onclick="closeOrderModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-100">å–æ¶ˆ</button>
            <button type="submit" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">åˆ›å»º</button>
          </div>
        </form>
      </div>
    </div>

    <!-- è¯¢ç›˜æ¨¡æ€æ¡† -->
    <div id="inquiryModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4 fade-in">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">æ·»åŠ è¯¢ç›˜</h3>
          <button onclick="closeInquiryModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
        </div>
        <form onsubmit="saveInquiry(event)">
          <div class="grid grid-cols-2 gap-4">
            <div class="col-span-2">
              <label class="block text-gray-700 mb-1">å®¢æˆ· *</label>
              <select id="inquiryCustomer" required class="w-full px-3 py-2 border rounded-lg"></select>
            </div>
            <div class="col-span-2">
              <label class="block text-gray-700 mb-1">äº§å“ *</label>
              <select id="inquiryProduct" required class="w-full px-3 py-2 border rounded-lg"></select>
            </div>
            <div>
              <label class="block text-gray-700 mb-1">æ•°é‡</label>
              <input type="number" id="inquiryQuantity" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 mb-1">å•ä½</label>
              <select id="inquiryUnit" class="w-full px-3 py-2 border rounded-lg">
                <option value="å¨">å¨</option>
                <option value="å¥—">å¥—</option>
                <option value="ä»¶">ä»¶</option>
              </select>
            </div>
            <div class="col-span-2">
              <label class="block text-gray-700 mb-1">è¯¢ç›˜å†…å®¹</label>
              <textarea id="inquiryContent" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
            </div>
          </div>
          <div class="flex justify-end gap-2 mt-4">
            <button type="button" onclick="closeInquiryModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-100">å–æ¶ˆ</button>
            <button type="submit" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Toastæç¤º -->
    <div id="toast" class="fixed top-4 right-4 transform translate-x-full transition-transform duration-300 z-50">
      <div id="toastContent" class="rounded-lg shadow-lg p-4 min-w-64"></div>
    </div>
  </div>

  <script>
    let token = localStorage.getItem('token');
    let currentUser = null;
    let customersData = [];
    let productsData = [];

    // åˆå§‹åŒ–
    window.onload = () => {
      if (token) checkAuth();
    };

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    async function checkAuth() {
      try {
        const res = await fetch('/api/me', { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        if (data.success) {
          currentUser = data.user;
          showMainApp();
        } else {
          logout();
        }
      } catch (e) {
        logout();
      }
    }

    // ç™»å½•
    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      
      if (!username || !password) {
        showToast('error', 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
        return false;
      }
      
      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        
        if (data.success) {
          token = data.token;
          currentUser = data.user;
          localStorage.setItem('token', token);
          showMainApp();
          showToast('success', 'ç™»å½•æˆåŠŸ');
        } else {
          showToast('error', data.message);
        }
      } catch (e) {
        showToast('error', 'ç™»å½•å¤±è´¥: ' + e.message);
      }
      return false;
    }

    // æ˜¾ç¤ºä¸»ç•Œé¢
    function showMainApp() {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('userName').textContent = currentUser.name;
      loadStats();
      loadCustomers();
      loadProducts();
    }

    // é€€å‡ºç™»å½•
    function logout() {
      token = null;
      currentUser = null;
      localStorage.removeItem('token');
      document.getElementById('loginPage').classList.remove('hidden');
      document.getElementById('mainApp').classList.add('hidden');
    }

    // é¡µé¢åˆ‡æ¢
    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
      document.getElementById(page + 'Page').classList.remove('hidden');
      document.querySelectorAll('.sidebar-item').forEach((item, i) => {
        item.classList.remove('active');
        if ((page === 'dashboard' && i === 0) || (page === 'customers' && i === 1) || 
            (page === 'products' && i === 2) || (page === 'orders' && i === 3) || 
            (page === 'inquiries' && i === 4) || (page === 'ai' && i === 5)) {
          item.classList.add('active');
        }
      });
      if (page === 'dashboard') loadStats();
      if (page === 'customers') loadCustomers();
      if (page === 'products') loadProducts();
      if (page === 'orders') loadOrders();
      if (page === 'inquiries') loadInquiries();
      if (page === 'ai') loadApiKey();
    }

    // ==================== AIåŠŸèƒ½ ====================
    let savedApiKey = '';

    function loadApiKey() {
      const key = localStorage.getItem('deepseekApiKey');
      if (key) {
        savedApiKey = key;
        document.getElementById('deepseekApiKey').value = key;
      }
    }

    function saveApiKey() {
      const key = document.getElementById('deepseekApiKey').value.trim();
      if (!key) {
        showToast('error', 'è¯·è¾“å…¥API Key');
        return;
      }
      localStorage.setItem('deepseekApiKey', key);
      savedApiKey = key;
      showToast('success', 'API Keyä¿å­˜æˆåŠŸ');
    }

    // ä¸‹è½½Excelæ¨¡æ¿
    function downloadTemplate() {
      const headers = [
        'å…¬å¸å', 'å›½å®¶', 'åœ°å€', 'å®¢æˆ·ç±»å‹', 'å®¢æˆ·ç­‰çº§',
        'ç½‘å€', 'å…¬å¸ç¤¾åª’è´¦å·', 'æ‰€æœ‰è”ç³»äºº', 'è”ç³»æ–¹å¼',
        'ä¸»è¥äº§å“', 'é‡‡è´­å‘¨æœŸ', 'å¹´é‡‡è´­é¢', 'æ¥æºæ¸ é“',
        'è·Ÿè¿›æƒ…å†µ', 'æœ€æ–°è·Ÿè¿›æ—¶é—´', 'æœ€æ–°è·Ÿè¿›å†…å®¹'
      ];
      
      const sampleData = [
        ['ABC Company', 'ç¾å›½', 'New York', 'distributor', 'A', 'https://abc.com', 'https://linkedin.com/abc', 'John Smith', 'john@abc.com', 'æ¿ç°§', 'å­£åº¦', '$500,000', 'å±•ä¼š', 'è·Ÿè¿›ä¸­', '2024-01-15', 'å·²å‘é€æŠ¥ä»·'],
        ['DEF GmbH', 'å¾·å›½', 'Berlin', 'manufacturer', 'B', 'https://def.de', '', 'Hans Mueller', '+49-123-456', 'åº•ç›˜', 'æœˆåº¦', '$200,000', 'ç½‘ç»œ', 'æ½œåœ¨', '2024-01-10', 'ç­‰å¾…å›å¤']
      ];
      
      const ws = XLSX.utils.aoa_to_sheet([headers, ...sampleData]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'å®¢æˆ·æ¨¡æ¿');
      
      // è®¾ç½®åˆ—å®½
      ws['!cols'] = headers.map(() => ({ wch: 15 }));
      
      XLSX.writeFile(wb, 'å®¢æˆ·å¯¼å…¥æ¨¡æ¿.xlsx');
      showToast('success', 'æ¨¡æ¿ä¸‹è½½æˆåŠŸï¼');
    }

    async function importExcel(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (!savedApiKey) {
        showToast('error', 'è¯·å…ˆåœ¨AIåŠ©æ‰‹é¡µé¢ä¿å­˜API Key');
        return;
      }

      showToast('info', 'æ­£åœ¨è§£æExcelæ–‡ä»¶...');
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const fileData = new Uint8Array(e.target.result);
          const workbook = XLSX.read(fileData, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
          
          if (jsonData.length < 2) {
            showToast('error', 'Excelæ–‡ä»¶å†…å®¹ä¸ºç©º');
            return;
          }
          
          const headers = jsonData[0];
          const rows = jsonData.slice(1).filter(row => row.some(cell => cell));
          
          showToast('info', `è§£æå®Œæˆï¼Œå…±${rows.length}æ¡æ•°æ®ï¼Œæ­£åœ¨AIæ™ºèƒ½åˆ†æ...`);
          
          const prompt = `è¯·åˆ†æä»¥ä¸‹Excelè¡¨æ ¼æ•°æ®ï¼Œæå–å®¢æˆ·ä¿¡æ¯ã€‚æˆ‘éœ€è¦ä½ è¿”å›ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
company(å…¬å¸å), country(å›½å®¶), address(åœ°å€), type(å®¢æˆ·ç±»å‹:distributor/chassis/manufacturer/other), level(å®¢æˆ·ç­‰çº§:A/B/C),
website(ç½‘å€), socialMedia(å…¬å¸ç¤¾åª’è´¦å·), contactPerson(æ‰€æœ‰è”ç³»äºº), contactInfo(è”ç³»æ–¹å¼),
mainProducts(ä¸»è¥äº§å“), purchaseCycle(é‡‡è´­å‘¨æœŸ), annualPurchase(å¹´é‡‡è´­é¢), sourceChannel(æ¥æºæ¸ é“),
followUpStatus(è·Ÿè¿›æƒ…å†µ), lastFollowUp(æœ€æ–°è·Ÿè¿›æ—¶é—´), followUpContent(æœ€æ–°è·Ÿè¿›å†…å®¹)ã€‚

Excelè¡¨å¤´: ${JSON.stringify(headers)}
æ•°æ®è¡Œ: ${JSON.stringify(rows.slice(0, 20))}

è¯·åªè¿”å›JSONæ•°ç»„ï¼Œä¸è¦å…¶ä»–æ–‡å­—ã€‚å¦‚æœæ— æ³•ç¡®å®šæŸä¸ªå­—æ®µï¼Œè¯·ä½¿ç”¨ç©ºå­—ç¬¦ä¸²æˆ–é»˜è®¤å€¼ã€‚`;

          console.log('Sending AI request with API Key:', savedApiKey.substring(0, 10) + '...');
          
          const res = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ message: prompt, apiKey: savedApiKey })
          });
          
          console.log('AI response status:', res.status);
          
          const result = await res.json();
          console.log('AI result:', result);
          
          if (result.success) {
            try {
              console.log('AI response content:', result.response);
              const customers = JSON.parse(result.response);
              console.log('Parsed customers:', customers);
              if (Array.isArray(customers) && customers.length > 0) {
                let importedCount = 0;
                for (const c of customers) {
                  console.log('Importing customer:', c);
                  const customerData = {
                    name: c.company || c.å…¬å¸å || 'æœªçŸ¥',
                    company: c.company || c.å…¬å¸å || '',
                    country: c.country || c.å›½å®¶ || 'æœªçŸ¥',
                    address: c.address || c.åœ°å€ || '',
                    type: c.type || c.å®¢æˆ·ç±»å‹ || '',
                    level: c.level || c.å®¢æˆ·ç­‰çº§ || '',
                    website: c.website || c.ç½‘å€ || '',
                    socialMedia: c.socialMedia || c.å…¬å¸ç¤¾åª’è´¦å· || c.ç¤¾åª’è´¦å· || '',
                    contactPerson: c.contactPerson || c.æ‰€æœ‰è”ç³»äºº || c.è”ç³»äºº || '',
                    contactInfo: c.contactInfo || c.è”ç³»æ–¹å¼ || '',
                    mainProducts: c.mainProducts || c.ä¸»è¥äº§å“ || '',
                    purchaseCycle: c.purchaseCycle || c.é‡‡è´­å‘¨æœŸ || '',
                    annualPurchase: c.annualPurchase || c.å¹´é‡‡è´­é¢ || '',
                    sourceChannel: c.sourceChannel || c.æ¥æºæ¸ é“ || '',
                    followUpStatus: c.followUpStatus || c.è·Ÿè¿›æƒ…å†µ || '',
                    lastFollowUp: c.lastFollowUp || c.æœ€æ–°è·Ÿè¿›æ—¶é—´ || '',
                    followUpContent: c.followUpContent || c.æœ€æ–°è·Ÿè¿›å†…å®¹ || '',
                    status: 'potential'
                  };
                  const saveRes = await fetch('/api/customers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(customerData)
                  });
                  const saveResult = await saveRes.json();
                  if (saveResult.success) importedCount++;
                }
                showToast('success', `æˆåŠŸå¯¼å…¥${importedCount}ä¸ªå®¢æˆ·ï¼`);
                loadCustomers();
              } else {
                showToast('error', 'AIè¿”å›æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
              }
            } catch (parseErr) {
              console.error('Parse error:', parseErr);
              showToast('error', 'AIè¿”å›æ•°æ®æ ¼å¼æœ‰è¯¯: ' + parseErr.message);
            }
          } else {
            console.error('AI request failed:', result);
            showToast('error', result.message || 'AIè¯·æ±‚å¤±è´¥');
          }
        } catch (err) {
          showToast('error', 'æ–‡ä»¶è§£æå¤±è´¥: ' + err.message);
        }
      };
      reader.readAsArrayBuffer(file);
      event.target.value = '';
    }

    function quickAsk(question) {
      document.getElementById('aiInput').value = question;
      sendAIMessage();
    }

    // è”ç½‘åˆ†æå…¬å¸
    async function analyzeCompanyOnline() {
      const query = document.getElementById('webSearchQuery').value.trim();
      if (!query) {
        showToast('error', 'è¯·è¾“å…¥å…¬å¸åæˆ–ç½‘å€');
        return;
      }
      
      if (!savedApiKey) {
        showToast('error', 'è¯·å…ˆä¿å­˜API Key');
        return;
      }

      const chatMessages = document.getElementById('aiChatMessages');
      
      chatMessages.innerHTML += `
        <div class="flex gap-3 justify-end">
          <div class="bg-green-500 text-white rounded-lg p-3 max-w-[80%]">
            <p>ğŸ” è”ç½‘åˆ†æï¼š${query}</p>
          </div>
          <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0">
            <i class="fas fa-user text-gray-600 text-sm"></i>
          </div>
        </div>
      `;

      const loadingId = 'loading-web-' + Date.now();
      chatMessages.innerHTML += `
        <div id="${loadingId}" class="flex gap-3">
          <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
            <i class="fas fa-globe text-white text-sm"></i>
          </div>
          <div class="bg-gray-100 rounded-lg p-3">
            <p class="text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>æ­£åœ¨è”ç½‘æœç´¢åˆ†æ...</p>
          </div>
        </div>
      `;
      chatMessages.scrollTop = chatMessages.scrollHeight;

      const prompt = `è¯·å¸®æˆ‘åˆ†æè¿™å®¶å…¬å¸ï¼š"${query}"ã€‚

è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼ˆå¦‚æœå¯èƒ½ï¼‰ï¼š
1. å…¬å¸åŸºæœ¬ä¿¡æ¯ï¼ˆæˆç«‹æ—¶é—´ã€è§„æ¨¡ã€ä¸»è¥ä¸šåŠ¡ï¼‰
2. äº§å“ç±»å‹å’Œç‰¹ç‚¹
3. ç›®æ ‡å¸‚åœºå’Œå®¢æˆ·ç¾¤ä½“
4. å¯èƒ½çš„é‡‡è´­éœ€æ±‚åˆ†æ
5. è”ç³»æ–¹å¼ï¼ˆå¦‚æœæœ‰ï¼‰
6. ä¸å››å·åç‰è½¦è¾†æ¿ç°§æœ‰é™å…¬å¸çš„ä¸šåŠ¡åŒ¹é…åº¦åˆ†æ
7. å¼€å‘å»ºè®®

è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œæ ¼å¼æ¸…æ™°ã€‚`;

      try {
        const res = await fetch('/api/ai/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ message: prompt, apiKey: savedApiKey })
        });

        const data = await res.json();
        document.getElementById(loadingId).remove();

        if (data.success) {
          const formattedResponse = data.response.replace(/\n/g, '<br>');
          chatMessages.innerHTML += `
            <div class="flex gap-3">
              <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="fas fa-globe text-white text-sm"></i>
              </div>
              <div class="bg-green-50 rounded-lg p-3 max-w-[80%]">
                <p class="text-gray-700 whitespace-pre-wrap">${formattedResponse}</p>
                <div class="mt-3 pt-2 border-t border-green-200">
                  <button onclick="addCompanyToCRM('${query.replace(/'/g, "\\'")}')" class="text-sm bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
                    <i class="fas fa-plus mr-1"></i>æ·»åŠ åˆ°å®¢æˆ·ç®¡ç†
                  </button>
                </div>
              </div>
            </div>
          `;
        } else {
          chatMessages.innerHTML += `
            <div class="flex gap-3">
              <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="fas fa-exclamation text-white text-sm"></i>
              </div>
              <div class="bg-red-50 rounded-lg p-3">
                <p class="text-red-600">${data.message}</p>
              </div>
            </div>
          `;
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
      } catch (e) {
        document.getElementById(loadingId).remove();
        showToast('error', 'è”ç½‘åˆ†æå¤±è´¥: ' + e.message);
      }
    }

    // ä»AIé¡µé¢å¯¼å…¥Excel
    async function importExcelFromAI(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (!savedApiKey) {
        showToast('error', 'è¯·å…ˆåœ¨AIåŠ©æ‰‹é¡µé¢ä¿å­˜API Key');
        return;
      }

      showToast('info', 'æ­£åœ¨è§£æExcelæ–‡ä»¶...');
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const fileData = new Uint8Array(e.target.result);
          const workbook = XLSX.read(fileData, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
          
          if (jsonData.length < 2) {
            showToast('error', 'Excelæ–‡ä»¶å†…å®¹ä¸ºç©º');
            return;
          }
          
          const headers = jsonData[0];
          const rows = jsonData.slice(1).filter(row => row.some(cell => cell));
          
          showToast('info', `è§£æå®Œæˆï¼Œå…±${rows.length}æ¡æ•°æ®ï¼Œæ­£åœ¨AIæ™ºèƒ½åˆ†æ...`);
          
          const prompt = `è¯·åˆ†æä»¥ä¸‹Excelè¡¨æ ¼æ•°æ®ï¼Œæå–å®¢æˆ·ä¿¡æ¯ã€‚æˆ‘éœ€è¦ä½ è¿”å›ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
company(å…¬å¸å), country(å›½å®¶), address(åœ°å€), type(å®¢æˆ·ç±»å‹:distributor/chassis/manufacturer/other), level(å®¢æˆ·ç­‰çº§:A/B/C),
website(ç½‘å€), socialMedia(å…¬å¸ç¤¾åª’è´¦å·), contactPerson(æ‰€æœ‰è”ç³»äºº), contactInfo(è”ç³»æ–¹å¼),
mainProducts(ä¸»è¥äº§å“), purchaseCycle(é‡‡è´­å‘¨æœŸ), annualPurchase(å¹´é‡‡è´­é¢), sourceChannel(æ¥æºæ¸ é“),
followUpStatus(è·Ÿè¿›æƒ…å†µ), lastFollowUp(æœ€æ–°è·Ÿè¿›æ—¶é—´), followUpContent(æœ€æ–°è·Ÿè¿›å†…å®¹)ã€‚

Excelè¡¨å¤´: ${JSON.stringify(headers)}
æ•°æ®è¡Œ: ${JSON.stringify(rows.slice(0, 20))}

è¯·åªè¿”å›JSONæ•°ç»„ï¼Œä¸è¦å…¶ä»–æ–‡å­—ã€‚å¦‚æœæ— æ³•ç¡®å®šæŸä¸ªå­—æ®µï¼Œè¯·ä½¿ç”¨ç©ºå­—ç¬¦ä¸²æˆ–é»˜è®¤å€¼ã€‚`;

          const res = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ message: prompt, apiKey: savedApiKey })
          });
          
          const result = await res.json();
          
          if (result.success) {
            try {
              const customers = JSON.parse(result.response);
              if (Array.isArray(customers) && customers.length > 0) {
                let importedCount = 0;
                for (const c of customers) {
                  const customerData = {
                    name: c.company || c.å…¬å¸å || 'æœªçŸ¥',
                    company: c.company || c.å…¬å¸å || '',
                    country: c.country || c.å›½å®¶ || 'æœªçŸ¥',
                    address: c.address || c.åœ°å€ || '',
                    type: c.type || c.å®¢æˆ·ç±»å‹ || '',
                    level: c.level || c.å®¢æˆ·ç­‰çº§ || '',
                    website: c.website || c.ç½‘å€ || '',
                    socialMedia: c.socialMedia || c.å…¬å¸ç¤¾åª’è´¦å· || c.ç¤¾åª’è´¦å· || '',
                    contactPerson: c.contactPerson || c.æ‰€æœ‰è”ç³»äºº || c.è”ç³»äºº || '',
                    contactInfo: c.contactInfo || c.è”ç³»æ–¹å¼ || '',
                    mainProducts: c.mainProducts || c.ä¸»è¥äº§å“ || '',
                    purchaseCycle: c.purchaseCycle || c.é‡‡è´­å‘¨æœŸ || '',
                    annualPurchase: c.annualPurchase || c.å¹´é‡‡è´­é¢ || '',
                    sourceChannel: c.sourceChannel || c.æ¥æºæ¸ é“ || '',
                    followUpStatus: c.followUpStatus || c.è·Ÿè¿›æƒ…å†µ || '',
                    lastFollowUp: c.lastFollowUp || c.æœ€æ–°è·Ÿè¿›æ—¶é—´ || '',
                    followUpContent: c.followUpContent || c.æœ€æ–°è·Ÿè¿›å†…å®¹ || '',
                    status: 'potential'
                  };
                  const saveRes = await fetch('/api/customers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(customerData)
                  });
                  const saveResult = await saveRes.json();
                  if (saveResult.success) importedCount++;
                }
                showToast('success', `æˆåŠŸå¯¼å…¥${importedCount}ä¸ªå®¢æˆ·ï¼`);
              } else {
                showToast('error', 'AIè¿”å›æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
              }
            } catch (parseErr) {
              showToast('error', 'AIè¿”å›æ•°æ®æ ¼å¼æœ‰è¯¯: ' + parseErr.message);
            }
          } else {
            showToast('error', result.message || 'AIè¯·æ±‚å¤±è´¥');
          }
        } catch (err) {
          showToast('error', 'æ–‡ä»¶è§£æå¤±è´¥: ' + err.message);
        }
      };
      reader.readAsArrayBuffer(file);
      event.target.value = '';
    }

    // æ·»åŠ å…¬å¸åˆ°CRM
    async function addCompanyToCRM(companyName) {
      showCustomerModal();
      document.getElementById('customerName').value = companyName;
      document.getElementById('customerCompany').value = companyName;
      showToast('info', 'å·²æ‰“å¼€æ·»åŠ å®¢æˆ·çª—å£ï¼Œè¯·è¡¥å……å…¶ä»–ä¿¡æ¯');
    }

    async function sendAIMessage() {
      const input = document.getElementById('aiInput');
      const message = input.value.trim();
      if (!message) return;

      if (!savedApiKey) {
        showToast('error', 'è¯·å…ˆä¿å­˜API Key');
        return;
      }

      const chatMessages = document.getElementById('aiChatMessages');
      
      chatMessages.innerHTML += `
        <div class="flex gap-3 justify-end">
          <div class="bg-blue-500 text-white rounded-lg p-3 max-w-[80%]">
            <p>${message}</p>
          </div>
          <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0">
            <i class="fas fa-user text-gray-600 text-sm"></i>
          </div>
        </div>
      `;

      input.value = '';
      chatMessages.scrollTop = chatMessages.scrollHeight;

      const loadingId = 'loading-' + Date.now();
      chatMessages.innerHTML += `
        <div id="${loadingId}" class="flex gap-3">
          <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center flex-shrink-0">
            <i class="fas fa-robot text-white text-sm"></i>
          </div>
          <div class="bg-gray-100 rounded-lg p-3">
            <p class="text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>æ€è€ƒä¸­...</p>
          </div>
        </div>
      `;
      chatMessages.scrollTop = chatMessages.scrollHeight;

      try {
        const res = await fetch('/api/ai/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ message, apiKey: savedApiKey })
        });

        const data = await res.json();
        document.getElementById(loadingId).remove();

        if (data.success) {
          const formattedResponse = data.response.replace(/\n/g, '<br>');
          chatMessages.innerHTML += `
            <div class="flex gap-3">
              <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="fas fa-robot text-white text-sm"></i>
              </div>
              <div class="bg-gray-100 rounded-lg p-3 max-w-[80%]">
                <p class="text-gray-700 whitespace-pre-wrap">${formattedResponse}</p>
              </div>
            </div>
          `;
        } else {
          chatMessages.innerHTML += `
            <div class="flex gap-3">
              <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="fas fa-exclamation text-white text-sm"></i>
              </div>
              <div class="bg-red-50 rounded-lg p-3">
                <p class="text-red-600">${data.message}</p>
              </div>
            </div>
          `;
        }
      } catch (e) {
        document.getElementById(loadingId).remove();
        chatMessages.innerHTML += `
          <div class="flex gap-3">
            <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center flex-shrink-0">
              <i class="fas fa-exclamation text-white text-sm"></i>
            </div>
            <div class="bg-red-50 rounded-lg p-3">
              <p class="text-red-600">è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>
            </div>
          </div>
        `;
      }

      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
      try {
        const res = await fetch('/api/stats', { headers: { 'Authorization': `Bearer ${token}` } });
        const res2 = await fetch('/api/customers', { headers: { 'Authorization': `Bearer ${token}` } });
        const res3 = await fetch('/api/orders', { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        const customersData = await res2.json();
        const ordersData = await res3.json();
        
        if (data.success) {
          document.getElementById('statCustomers').textContent = data.data.totalCustomers;
          document.getElementById('statOrders').textContent = data.data.totalOrders;
          document.getElementById('statInquiries').textContent = data.data.newInquiries;
          document.getElementById('statPending').textContent = data.data.pendingOrders;
          
          // æ¸²æŸ“å›¾è¡¨
          renderCharts(customersData.data || [], ordersData.data || []);
        }
      } catch (e) {
        console.error(e);
      }
    }

    // å›¾è¡¨ç¿»é¡µ
    let currentChartPage = 1;
    const totalChartPages = 4;
    let charts = {};

    function prevChart() {
      if (currentChartPage > 1) {
        currentChartPage--;
        showChart(currentChartPage);
      }
    }

    function nextChart() {
      if (currentChartPage < totalChartPages) {
        currentChartPage++;
        showChart(currentChartPage);
      }
    }

    function showChart(page) {
      document.getElementById('chartPageInfo').textContent = page + ' / ' + totalChartPages;
      const container = document.getElementById('chartContainer');
      container.innerHTML = '<canvas id="chartCanvas" height="150"></canvas>';
      container.style.maxHeight = '350px';
      container.style.overflow = 'auto';
      container.style.textAlign = 'center';
      
      const chartTitles = ['å®¢æˆ·ç±»å‹åˆ†å¸ƒ', 'å®¢æˆ·ç­‰çº§åˆ†å¸ƒ', 'è®¢å•çŠ¶æ€åˆ†å¸ƒ', 'æœ€è¿‘è®¢å•è¶‹åŠ¿'];
      container.querySelector('h3')?.remove();
      container.innerHTML = '<h3 class="text-lg font-bold text-gray-800 mb-4">' + chartTitles[page-1] + '</h3><canvas id="chartCanvas" height="150"></canvas>';
      container.style.maxHeight = '350px';
      container.style.overflow = 'auto';
      container.style.textAlign = 'center';
      
      if (charts[page]) {
        charts[page].destroy();
      }
      
      const chartData = getChartData(page);
      charts[page] = new Chart(document.getElementById('chartCanvas'), chartData);
    }

    function getChartData(page) {
      const customers = window.customersData || [];
      const orders = window.ordersData || [];
      
      if (page === 1) {
        const typeCount = { distributor: 0, chassis: 0, manufacturer: 0, other: 0 };
        customers.forEach(c => { if (c.type && typeCount[c.type] !== undefined) typeCount[c.type]++; });
        return {
          type: 'doughnut',
          data: {
            labels: ['åˆ†é”€å•†', 'åº•ç›˜å•†', 'åˆ¶é€ å•†', 'å…¶ä»–'],
            datasets: [{ data: [typeCount.distributor, typeCount.chassis, typeCount.manufacturer, typeCount.other], backgroundColor: ['#8B5CF6', '#3B82F6', '#10B981', '#6B7280'] }]
          },
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        };
      } else if (page === 2) {
        const levelCount = { A: 0, B: 0, C: 0 };
        customers.forEach(c => { if (c.level && levelCount[c.level] !== undefined) levelCount[c.level]++; });
        return {
          type: 'pie',
          data: {
            labels: ['Açº§(æ ¸å¿ƒ)', 'Bçº§(é‡è¦)', 'Cçº§(æ™®é€š)'],
            datasets: [{ data: [levelCount.A, levelCount.B, levelCount.C], backgroundColor: ['#EF4444', '#F59E0B', '#10B981'] }]
          },
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        };
      } else if (page === 3) {
        const statusCount = { pending: 0, confirmed: 0, producing: 0, shipped: 0, completed: 0 };
        orders.forEach(o => { if (o.status && statusCount[o.status] !== undefined) statusCount[o.status]++; });
        return {
          type: 'bar',
          data: {
            labels: ['å¾…å¤„ç†', 'å·²ç¡®è®¤', 'ç”Ÿäº§ä¸­', 'å·²å‘è´§', 'å·²å®Œæˆ'],
            datasets: [{ label: 'è®¢å•æ•°', data: [statusCount.pending, statusCount.confirmed, statusCount.producing, statusCount.shipped, statusCount.completed], backgroundColor: ['#F59E0B', '#3B82F6', '#8B5CF6', '#6366F1', '#10B981'] }]
          },
          options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        };
      } else {
        const last7Days = [];
        for (let i = 6; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          last7Days.push(d.toISOString().split('T')[0]);
        }
        const orderByDay = last7Days.map(day => orders.filter(o => o.date && o.date.startsWith(day)).length);
        return {
          type: 'line',
          data: {
            labels: last7Days.map(d => d.slice(5)),
            datasets: [{ label: 'è®¢å•æ•°', data: orderByDay, borderColor: '#3B82F6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.4 }]
          },
          options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        };
      }
    }

    // æ¸²æŸ“å›¾è¡¨
    function renderCharts(customers, orders) {
      window.customersData = customers;
      window.ordersData = orders;
      currentChartPage = 1;
      showChart(1);
    }

    // åŠ è½½å®¢æˆ·
    async function loadCustomers() {
      try {
        const search = document.getElementById('customerSearch')?.value || '';
        const status = document.getElementById('customerStatus')?.value || '';
        const type = document.getElementById('customerType')?.value || '';
        const level = document.getElementById('customerLevel')?.value || '';
        const res = await fetch(`/api/customers?search=${search}&status=${status}&type=${type}&level=${level}`, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        if (data.success) {
          customersData = data.data;
          const html = data.data.map(c => `
            <tr class="border-b hover:bg-gray-50">
              <td class="px-2 py-2 whitespace-nowrap">${c.company || c.name}</td>
              <td class="px-2 py-2">${c.country || '-'}</td>
              <td class="px-2 py-2">${c.address || '-'}</td>
              <td class="px-2 py-2"><span class="px-2 py-1 rounded text-xs ${getCustomerTypeColor(c.type)}">${getCustomerTypeText(c.type)}</span></td>
              <td class="px-2 py-2"><span class="px-2 py-1 rounded text-xs ${getCustomerLevelColor(c.level)}">${c.level || '-'}</span></td>
              <td class="px-2 py-2">${c.website ? '<a href="'+c.website+'" target="_blank" class="text-blue-600 hover:underline">é“¾æ¥</a>' : '-'}</td>
              <td class="px-2 py-2">${c.socialMedia ? '<a href="'+c.socialMedia+'" target="_blank" class="text-blue-600 hover:underline">é“¾æ¥</a>' : '-'}</td>
              <td class="px-2 py-2">${c.contactPerson || '-'}</td>
              <td class="px-2 py-2">${c.contactInfo || c.phone || '-'}</td>
              <td class="px-2 py-2">${c.mainProducts || '-'}</td>
              <td class="px-2 py-2">${c.purchaseCycle || '-'}</td>
              <td class="px-2 py-2">${c.annualPurchase || '-'}</td>
              <td class="px-2 py-2">${c.sourceChannel || '-'}</td>
              <td class="px-2 py-2">${c.followUpStatus || '-'}</td>
              <td class="px-2 py-2">${c.lastFollowUp || '-'}</td>
              <td class="px-2 py-2">${c.followUpContent || '-'}</td>
              <td class="px-2 py-2">
                <button onclick="editCustomer('${c.id}')" class="text-orange-600 hover:text-orange-800 mr-1"><i class="fas fa-edit"></i></button>
                <button onclick="deleteCustomer('${c.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
              </td>
            </tr>
          `).join('') || '<tr><td colspan="20" class="text-center py-4 text-gray-500">æš‚æ— å®¢æˆ·æ•°æ®</td></tr>';
          document.getElementById('customerList').innerHTML = html;
        }
      } catch (e) {
        console.error(e);
      }
    }

    function getCustomerTypeColor(type) {
      const colors = {
        'distributor': 'bg-purple-100 text-purple-700',
        'chassis': 'bg-blue-100 text-blue-700',
        'manufacturer': 'bg-green-100 text-green-700',
        'other': 'bg-gray-100 text-gray-700'
      };
      return colors[type] || 'bg-gray-100 text-gray-700';
    }

    function getCustomerTypeText(type) {
      const texts = {
        'distributor': 'åˆ†é”€å•†',
        'chassis': 'åº•ç›˜å•†',
        'manufacturer': 'åˆ¶é€ å•†',
        'other': 'å…¶ä»–'
      };
      return texts[type] || 'æœªåˆ†ç±»';
    }

    function getCustomerLevelColor(level) {
      const colors = {
        'A': 'bg-red-100 text-red-700',
        'B': 'bg-yellow-100 text-yellow-700',
        'C': 'bg-green-100 text-green-700'
      };
      return colors[level] || 'bg-gray-100 text-gray-700';
    }

    // åŠ è½½äº§å“
    async function loadProducts() {
      try {
        const res = await fetch('/api/products', { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        if (data.success) {
          productsData = data.data;
          const html = data.data.map(p => `
            <div class="bg-gray-50 rounded-lg p-4 card-hover transition">
              <div class="flex justify-between items-start mb-2">
                <h4 class="font-bold text-gray-800">${p.name}</h4>
                <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">${p.category}</span>
              </div>
              <p class="text-sm text-gray-500 mb-2">${p.description || ''}</p>
              <div class="text-xs text-gray-400 space-y-1">
                <p><i class="fas fa-cog mr-1"></i>æè´¨: ${p.spec || '-'}</p>
                <p><i class="fas fa-ruler mr-1"></i>åšåº¦: ${p.thickness || '-'}</p>
                <p><i class="fas fa-arrows-alt-h mr-1"></i>å®½åº¦: ${p.width || '-'}</p>
              </div>
              <div class="flex justify-end mt-3 pt-3 border-t">
                <button onclick="editProduct('${p.id}')" class="text-blue-600 hover:text-blue-800 text-sm mr-3"><i class="fas fa-edit mr-1"></i>ç¼–è¾‘</button>
              </div>
            </div>
          `).join('');
          document.getElementById('productList').innerHTML = html;
        }
      } catch (e) {
        console.error(e);
      }
    }

    // åŠ è½½è®¢å•
    async function loadOrders() {
      try {
        const status = document.getElementById('orderStatus')?.value || '';
        const res = await fetch(`/api/orders?status=${status}`, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        if (data.success) {
          const html = data.data.map(o => `
            <tr class="border-b hover:bg-gray-50">
              <td class="px-4 py-3 font-mono">${o.id}</td>
              <td class="px-4 py-3">${o.customerName || '-'}</td>
              <td class="px-4 py-3">${o.productName || '-'}</td>
              <td class="px-4 py-3">${o.quantity} ${o.unit}</td>
              <td class="px-4 py-3">$${o.amount || 0}</td>
              <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs ${getStatusColor(o.status)}">${getStatusText(o.status)}</span></td>
              <td class="px-4 py-3">
                <select onchange="updateOrderStatus('${o.id}', this.value)" class="text-sm border rounded px-2 py-1">
                  <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>å¾…å¤„ç†</option>
                  <option value="confirmed" ${o.status === 'confirmed' ? 'selected' : ''}>å·²ç¡®è®¤</option>
                  <option value="producing" ${o.status === 'producing' ? 'selected' : ''}>ç”Ÿäº§ä¸­</option>
                  <option value="shipped" ${o.status === 'shipped' ? 'selected' : ''}>å·²å‘è´§</option>
                  <option value="completed" ${o.status === 'completed' ? 'selected' : ''}>å·²å®Œæˆ</option>
                </select>
              </td>
            </tr>
          `).join('') || '<tr><td colspan="7" class="text-center py-4 text-gray-500">æš‚æ— è®¢å•æ•°æ®</td></tr>';
          document.getElementById('orderList').innerHTML = html;
        }
      } catch (e) {
        console.error(e);
      }
    }

    // åŠ è½½è¯¢ç›˜
    async function loadInquiries() {
      try {
        const status = document.getElementById('inquiryStatus')?.value || '';
        const res = await fetch(`/api/inquiries?status=${status}`, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        if (data.success) {
          const html = data.data.map(i => `
            <tr class="border-b hover:bg-gray-50">
              <td class="px-4 py-3 font-mono">${i.id}</td>
              <td class="px-4 py-3">${i.customerName || '-'}</td>
              <td class="px-4 py-3">${i.productName || '-'}</td>
              <td class="px-4 py-3">${i.quantity || '-'} ${i.unit || ''}</td>
              <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs ${getInquiryStatusColor(i.status)}">${getInquiryStatusText(i.status)}</span></td>
              <td class="px-4 py-3">${new Date(i.createdAt).toLocaleDateString()}</td>
              <td class="px-4 py-3">
                <select onchange="updateInquiryStatus('${i.id}', this.value)" class="text-sm border rounded px-2 py-1">
                  <option value="new" ${i.status === 'new' ? 'selected' : ''}>æ–°è¯¢ç›˜</option>
                  <option value="processing" ${i.status === 'processing' ? 'selected' : ''}>å¤„ç†ä¸­</option>
                  <option value="quoted" ${i.status === 'quoted' ? 'selected' : ''}>å·²æŠ¥ä»·</option>
                  <option value="closed" ${i.status === 'closed' ? 'selected' : ''}>å·²å…³é—­</option>
                </select>
              </td>
            </tr>
          `).join('') || '<tr><td colspan="7" class="text-center py-4 text-gray-500">æš‚æ— è¯¢ç›˜æ•°æ®</td></tr>';
          document.getElementById('inquiryList').innerHTML = html;
        }
      } catch (e) {
        console.error(e);
      }
    }

    // çŠ¶æ€é¢œè‰²å’Œæ–‡æœ¬
    function getStatusColor(s) {
      const colors = { pending: 'bg-yellow-100 text-yellow-600', confirmed: 'bg-blue-100 text-blue-600', producing: 'bg-purple-100 text-purple-600', shipped: 'bg-indigo-100 text-indigo-600', completed: 'bg-green-100 text-green-600' };
      return colors[s] || 'bg-gray-100 text-gray-600';
    }
    function getStatusText(s) {
      const texts = { pending: 'å¾…å¤„ç†', confirmed: 'å·²ç¡®è®¤', producing: 'ç”Ÿäº§ä¸­', shipped: 'å·²å‘è´§', completed: 'å·²å®Œæˆ' };
      return texts[s] || s;
    }
    function getInquiryStatusColor(s) {
      const colors = { new: 'bg-red-100 text-red-600', processing: 'bg-yellow-100 text-yellow-600', quoted: 'bg-blue-100 text-blue-600', closed: 'bg-gray-100 text-gray-600' };
      return colors[s] || 'bg-gray-100 text-gray-600';
    }
    function getInquiryStatusText(s) {
      const texts = { new: 'æ–°è¯¢ç›˜', processing: 'å¤„ç†ä¸­', quoted: 'å·²æŠ¥ä»·', closed: 'å·²å…³é—­' };
      return texts[s] || s;
    }
    function getCustomerStatusColor(s) {
      const colors = { active: 'bg-green-100 text-green-600', inactive: 'bg-gray-100 text-gray-600', potential: 'bg-blue-100 text-blue-600' };
      return colors[s] || 'bg-gray-100 text-gray-600';
    }
    function getCustomerStatusText(s) {
      const texts = { active: 'æ´»è·ƒ', inactive: 'ä¸æ´»è·ƒ', potential: 'æ½œåœ¨' };
      return texts[s] || s;
    }

    // å®¢æˆ·æ“ä½œ
    function showCustomerModal(id = null) {
      document.getElementById('customerModal').classList.remove('hidden');
      document.getElementById('customerModalTitle').textContent = id ? 'ç¼–è¾‘å®¢æˆ·' : 'æ·»åŠ å®¢æˆ·';
      document.getElementById('customerId').value = id || '';
      if (id) {
        const c = customersData.find(x => x.id === id);
        if (c) {
          document.getElementById('customerName').value = c.name;
          document.getElementById('customerCompany').value = c.company || '';
          document.getElementById('customerCountry').value = c.country;
          document.getElementById('customerStatusInput').value = c.status || 'potential';
          document.getElementById('customerTypeInput').value = c.type || '';
          document.getElementById('customerLevelInput').value = c.level || '';
          document.getElementById('customerAddress').value = c.address || '';
          document.getElementById('customerWebsite').value = c.website || '';
          document.getElementById('customerSocialMedia').value = c.socialMedia || '';
          document.getElementById('customerContactPerson').value = c.contactPerson || '';
          document.getElementById('customerContactInfo').value = c.contactInfo || '';
          document.getElementById('customerMainProducts').value = c.mainProducts || '';
          document.getElementById('customerPurchaseCycle').value = c.purchaseCycle || '';
          document.getElementById('customerAnnualPurchase').value = c.annualPurchase || '';
          document.getElementById('customerSourceChannel').value = c.sourceChannel || '';
          document.getElementById('customerFollowUpStatus').value = c.followUpStatus || '';
          document.getElementById('customerLastFollowUp').value = c.lastFollowUp || '';
          document.getElementById('customerFollowUpContent').value = c.followUpContent || '';
        }
      } else {
        document.getElementById('customerName').value = '';
        document.getElementById('customerCompany').value = '';
        document.getElementById('customerCountry').value = '';
        document.getElementById('customerStatusInput').value = 'potential';
        document.getElementById('customerTypeInput').value = '';
        document.getElementById('customerLevelInput').value = '';
        document.getElementById('customerAddress').value = '';
        document.getElementById('customerWebsite').value = '';
        document.getElementById('customerSocialMedia').value = '';
        document.getElementById('customerContactPerson').value = '';
        document.getElementById('customerContactInfo').value = '';
        document.getElementById('customerMainProducts').value = '';
        document.getElementById('customerPurchaseCycle').value = '';
        document.getElementById('customerAnnualPurchase').value = '';
        document.getElementById('customerSourceChannel').value = '';
        document.getElementById('customerFollowUpStatus').value = '';
        document.getElementById('customerLastFollowUp').value = '';
        document.getElementById('customerFollowUpContent').value = '';
      }
    }
    function closeCustomerModal() { document.getElementById('customerModal').classList.add('hidden'); }
    function editCustomer(id) { showCustomerModal(id); }
    async function saveCustomer(e) {
      e.preventDefault();
      const id = document.getElementById('customerId').value;
      const data = {
        name: document.getElementById('customerName').value,
        company: document.getElementById('customerCompany').value,
        country: document.getElementById('customerCountry').value,
        status: document.getElementById('customerStatusInput').value,
        type: document.getElementById('customerTypeInput').value,
        level: document.getElementById('customerLevelInput').value,
        address: document.getElementById('customerAddress').value,
        website: document.getElementById('customerWebsite').value,
        socialMedia: document.getElementById('customerSocialMedia').value,
        contactPerson: document.getElementById('customerContactPerson').value,
        contactInfo: document.getElementById('customerContactInfo').value,
        mainProducts: document.getElementById('customerMainProducts').value,
        purchaseCycle: document.getElementById('customerPurchaseCycle').value,
        annualPurchase: document.getElementById('customerAnnualPurchase').value,
        sourceChannel: document.getElementById('customerSourceChannel').value,
        followUpStatus: document.getElementById('customerFollowUpStatus').value,
        lastFollowUp: document.getElementById('customerLastFollowUp').value,
        followUpContent: document.getElementById('customerFollowUpContent').value
      };
      try {
        const res = await fetch(`/api/customers${id ? '/' + id : ''}`, {
          method: id ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          closeCustomerModal();
          loadCustomers();
          showToast('success', id ? 'å®¢æˆ·æ›´æ–°æˆåŠŸ' : 'å®¢æˆ·æ·»åŠ æˆåŠŸ');
        } else {
          showToast('error', result.message);
        }
      } catch (e) {
        showToast('error', 'æ“ä½œå¤±è´¥');
      }
    }
    async function deleteCustomer(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå®¢æˆ·å—ï¼Ÿ')) return;
      try {
        const res = await fetch(`/api/customers/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
        const result = await res.json();
        if (result.success) {
          loadCustomers();
          showToast('success', 'å®¢æˆ·åˆ é™¤æˆåŠŸ');
        } else {
          showToast('error', result.message);
        }
      } catch (e) {
        showToast('error', 'åˆ é™¤å¤±è´¥');
      }
    }

    // äº§å“æ“ä½œ
    function showProductModal(id = null) {
      document.getElementById('productModal').classList.remove('hidden');
      document.getElementById('productModalTitle').textContent = id ? 'ç¼–è¾‘äº§å“' : 'æ·»åŠ äº§å“';
      document.getElementById('productId').value = id || '';
      if (id) {
        const p = productsData.find(x => x.id === id);
        if (p) {
          document.getElementById('productName').value = p.name;
          document.getElementById('productCategory').value = p.category;
          document.getElementById('productSpec').value = p.spec || '';
          document.getElementById('productThickness').value = p.thickness || '';
          document.getElementById('productWidth').value = p.width || '';
          document.getElementById('productDescription').value = p.description || '';
        }
      } else {
        document.getElementById('productName').value = '';
        document.getElementById('productCategory').value = 'é‡å‹è½¦ç³»åˆ—';
        document.getElementById('productSpec').value = '';
        document.getElementById('productThickness').value = '';
        document.getElementById('productWidth').value = '';
        document.getElementById('productDescription').value = '';
      }
    }
    function closeProductModal() { document.getElementById('productModal').classList.add('hidden'); }
    function editProduct(id) { showProductModal(id); }
    async function saveProduct(e) {
      e.preventDefault();
      const id = document.getElementById('productId').value;
      const data = {
        name: document.getElementById('productName').value,
        category: document.getElementById('productCategory').value,
        spec: document.getElementById('productSpec').value,
        thickness: document.getElementById('productThickness').value,
        width: document.getElementById('productWidth').value,
        description: document.getElementById('productDescription').value
      };
      try {
        const res = await fetch(`/api/products${id ? '/' + id : ''}`, {
          method: id ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          closeProductModal();
          loadProducts();
          showToast('success', id ? 'äº§å“æ›´æ–°æˆåŠŸ' : 'äº§å“æ·»åŠ æˆåŠŸ');
        } else {
          showToast('error', result.message);
        }
      } catch (e) {
        showToast('error', 'æ“ä½œå¤±è´¥');
      }
    }

    // è®¢å•æ“ä½œ
    function showOrderModal() {
      document.getElementById('orderModal').classList.remove('hidden');
      const customerSelect = document.getElementById('orderCustomer');
      const productSelect = document.getElementById('orderProduct');
      customerSelect.innerHTML = customersData.map(c => `<option value="${c.id}">${c.name} (${c.country})</option>`).join('');
      productSelect.innerHTML = productsData.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }
    function closeOrderModal() { document.getElementById('orderModal').classList.add('hidden'); }
    async function saveOrder(e) {
      e.preventDefault();
      const customerId = document.getElementById('orderCustomer').value;
      const productId = document.getElementById('orderProduct').value;
      const customer = customersData.find(c => c.id === customerId);
      const product = productsData.find(p => p.id === productId);
      
      const data = {
        customerId,
        customerName: customer?.name,
        productId,
        productName: product?.name,
        quantity: document.getElementById('orderQuantity').value,
        unit: document.getElementById('orderUnit').value,
        price: document.getElementById('orderPrice').value,
        amount: document.getElementById('orderAmount').value,
        notes: document.getElementById('orderNotes').value
      };
      try {
        const res = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          closeOrderModal();
          loadOrders();
          showToast('success', 'è®¢å•åˆ›å»ºæˆåŠŸ');
        } else {
          showToast('error', result.message);
        }
      } catch (e) {
        showToast('error', 'æ“ä½œå¤±è´¥');
      }
    }
    async function updateOrderStatus(id, status) {
      try {
        const res = await fetch(`/api/orders/${id}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ status })
        });
        const result = await res.json();
        if (result.success) {
          showToast('success', 'çŠ¶æ€æ›´æ–°æˆåŠŸ');
        } else {
          showToast('error', result.message);
        }
      } catch (e) {
        showToast('error', 'æ›´æ–°å¤±è´¥');
      }
    }

    // è¯¢ç›˜æ“ä½œ
    function showInquiryModal() {
      document.getElementById('inquiryModal').classList.remove('hidden');
      const customerSelect = document.getElementById('inquiryCustomer');
      const productSelect = document.getElementById('inquiryProduct');
      customerSelect.innerHTML = customersData.map(c => `<option value="${c.id}">${c.name} (${c.country})</option>`).join('');
      productSelect.innerHTML = productsData.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }
    function closeInquiryModal() { document.getElementById('inquiryModal').classList.add('hidden'); }
    async function saveInquiry(e) {
      e.preventDefault();
      const customerId = document.getElementById('inquiryCustomer').value;
      const productId = document.getElementById('inquiryProduct').value;
      const customer = customersData.find(c => c.id === customerId);
      const product = productsData.find(p => p.id === productId);
      
      const data = {
        customerId,
        customerName: customer?.name,
        productId,
        productName: product?.name,
        quantity: document.getElementById('inquiryQuantity').value,
        unit: document.getElementById('inquiryUnit').value,
        content: document.getElementById('inquiryContent').value
      };
      try {
        const res = await fetch('/api/inquiries', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          closeInquiryModal();
          loadInquiries();
          showToast('success', 'è¯¢ç›˜æ·»åŠ æˆåŠŸ');
        } else {
          showToast('error', result.message);
        }
      } catch (e) {
        showToast('error', 'æ“ä½œå¤±è´¥');
      }
    }
    async function updateInquiryStatus(id, status) {
      try {
        const res = await fetch(`/api/inquiries/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ status })
        });
        const result = await res.json();
        if (result.success) {
          showToast('success', 'çŠ¶æ€æ›´æ–°æˆåŠŸ');
        } else {
          showToast('error', result.message);
        }
      } catch (e) {
        showToast('error', 'æ›´æ–°å¤±è´¥');
      }
    }

    // Toastæç¤º
    function showToast(type, message) {
      const toast = document.getElementById('toast');
      const content = document.getElementById('toastContent');
      const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
      const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
      content.className = `${bgColor} rounded-lg shadow-lg p-4 min-w-64 text-white flex items-center`;
      content.innerHTML = `<i class="fas ${icon} mr-3 text-xl"></i><span>${message}</span>`;
      toast.classList.remove('translate-x-full');
      setTimeout(() => toast.classList.add('translate-x-full'), 3000);
    }
  </script>
</body>
</html>